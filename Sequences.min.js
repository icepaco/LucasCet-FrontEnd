var OBJECT_LINK="https://s3.amazonaws.com/unimasoft.data.test/";Array.prototype.deleteObject=function(objet2Delete){var iIndex=this.indexOf(objet2Delete);if(iIndex>-1)this.splice(iIndex,1)};Substance.prototype.findSubstance=function(subId){for(var i=0;i<ApplicationRepertoire.metaSubstances.length;i++){var sub=ApplicationRepertoire.metaSubstances[i];if(sub.Id==subId)return sub}for(var i=0;i<this.parent.listeSubstances.length;i++){var sub=this.parent.listeSubstances[i];if(sub.Id==subId)return sub}return null};
SubstancePotentielle.prototype.declareSubstance=function(dispPane,metaHandler){if(this.elemVisual){var img=$(this.elemVisual).find(".imgSub")[0];img=img.cloneNode(true);img.substance=this;img.onclick=metaHandler;dispPane.appendChild(img)}};SubstancePotentielle.prototype.foldSubstance=function(){};SubstancePotentielle.prototype.deploySubstance=function(){};
SubstanceAction.prototype.declareSubstance=function(dispPane,metaHandler){if(ApplicationRepertoire.ActiveSubstances.indexOf(this)==-1)if(this.elemVisual){var vid=$(this.elemVisual).find(".vidMotrice")[0];vid=vid.cloneNode(true);vid.substance=this;vid.onclick=metaHandler;if(typeof this.subPrinc=="string")this.subPrinc=this.findSubstance(this.subPrinc);if(this.subPrinc)this.subPrinc.declareSubstance(dispPane,metaHandler);ApplicationRepertoire.NouSub(this);this.foldSubstance();dispPane.appendChild(vid)}};
SubstanceAction.prototype.foldSubstance=function(){var princHolder=$(this.elemVisual).find(".listSubstance")[0];princHolder.style.display="none"};SubstanceAction.prototype.deploySubstance=function(){var princHolder=$(this.elemVisual).find(".listSubstance")[0];princHolder.style.display=""};
SubstanceRelation.prototype.declareSubstance=function(dispPane,metaHandler){if(ApplicationRepertoire.ActiveSubstances.indexOf(this)==-1)if(this.elemVisual){if(this.isAnim)var vid=$(this.elemVisual).find(".vidRel")[0];else var vid=$(this.elemVisual).find(".imgRel")[0];vid=vid.cloneNode(true);vid.substance=this;vid.onclick=metaHandler;if(typeof this.subRelie1=="string")this.subRelie1=this.findSubstance(this.subRelie1);if(this.subRelie1)this.subRelie1.declareSubstance(dispPane,metaHandler);if(typeof this.subRelie2==
"string")this.subRelie2=this.findSubstance(this.subRelie2);if(this.subRelie2)this.subRelie2.declareSubstance(dispPane,metaHandler);ApplicationRepertoire.NouSub(this);this.foldSubstance();dispPane.appendChild(vid)}};SubstanceRelation.prototype.foldSubstance=function(){var holder=$(this.elemVisual).find(".relHolder")[0];holder.style.display="none"};
SubstanceRelation.prototype.deploySubstance=function(){var firstHolder=$(this.elemVisual).find(".liee1")[0];var secondHolder=$(this.elemVisual).find(".liee2")[0];firstHolder.style.display="";secondHolder.style.display=""};
function Sequence(node,substanceLiees,bImg){if(!substanceLiees)substanceLiees=[];Substance.call(this,node);var selectedHolder;var selectionHolder;var seqSubstances=substanceLiees;var iterator=0;var seqNode=node;var xMeta;var bImage=bImg;if(node)xMeta=node.getElementsByTagName(Substance.MetaDataName)[0];this.recordSequence=function(){if(ApplicationRepertoire.ListeSequences.indexOf(this)==-1){var xListeSeq=this.xEx.documentElement;var xSeq;if(bImg)xSeq=this.xEx.createElement("Imaginaire");else xSeq=
this.xEx.createElement("Sequence");var xSubLiees=this.xEx.createElement("SubstancesLiees");var anim=this.xEx.createElement("Graphique");var address=this.xEx.createElement("Adresse");address.setAttribute("Url",this.Graphic);anim.setAttribute("Type","Animation");anim.appendChild(address);xSeq.setAttribute("Id",this.Id);xSeq.setAttribute("Name",this.Name);xSeq.appendChild(anim);var iter;while(iter=this.Substances){var xSubLiees=this.xDoc.createElement("SubstancesLiees");xSubLiees.setAttribute("TypeSubstance",
iter.type);xSubLiees.setAttribute("IdSubstance",iter.Id);xSeq.appendChild(xSubLiees)}xSeq.appendChild(xMeta);xListeSeq.appendChild(xSeq);ApplicationRepertoire.ListeSequences.push(this)}};this.selectSubstance=function(event){var selectVisual=event.currentTarget;var sequence=this.sequenceOwner;var selectedSubstance=selectVisual.parentSubstance;selectVisual.removeEventListener("click",sequence.selectSubstance);sequence.SelectedPane.appendChild(selectVisual);sequence.Substances=selectedSubstance;selectedSubstance.deploySubstance();
selectedSubstance.declareSubstance(Sequence.MetaPane,Sequence.MetaHandler);selectVisual.addEventListener("click",sequence.unselectSubstance)};this.unselectSubstance=function(event){var selectVisual=event.currentTarget;var sequence=this.sequenceOwner;var selectedSubstance=selectVisual.parentSubstance;selectVisual.removeEventListener("click",sequence.unselectSubstance);sequence.SelectionPane.appendChild(selectVisual);sequence.removeSubstance(selectedSubstance);selectVisual.addEventListener("click",
sequence.selectSubstance)};this.removeSubstance=function(substance){seqSubstances.deleteObject(substance)};Object.defineProperty(this,"SeqVideo",{get:function(){if(!this.elemVisual){var link=document.querySelector('link[rel="import"]');var article=link.import.querySelector("#seqTab");this.elemVisual=article.cloneNode(true)}var vid=$(this.elemVisual).find("#vidSeq")[0];vid.src=OBJECT_LINK+this.Graphic;return vid}});Object.defineProperty(this,"Substances",{get:function(){if(iterator>=seqSubstances.length){iterator=
0;return null}return seqSubstances[iterator++]},set:function(newVal){seqSubstances.push(newVal)}});Object.defineProperty(this,"SelectedPane",{set:function(newVal){selectedHolder=newVal},get:function(){return selectedHolder}});Object.defineProperty(this,"SelectionPane",{set:function(newVal){selectionHolder=newVal},get:function(){return selectionHolder}});Object.defineProperty(this,"Meta",{set:function(newVal){xMeta=newVal}});Object.defineProperty(this,"Node",{get:function(){return seqNode}})}Sequence.inheritsFrom(Substance);
Sequence.MetaPane;Sequence.MetaHandler;Sequence.prototype.getName=function(){if(this.elemVisual){var txt=$(this.elemVisual).find("#seqName")[0];return txt.value}else return""};
Sequence.prototype.getVisual=function(){if(!this.elemVisual){var link=document.querySelector('link[rel="import"]');var article=link.import.querySelector("#seqTab");this.elemVisual=article.cloneNode(true);var vid=$(this.elemVisual).find("#vidSeq")[0];vid.src=this.Url;vid.seqOwner=this;vid.visuEl=this.elemVisual;$(vid).attr("controls",true);var txt=$(this.elemVisual).find("#seqName")[0];txt.value=this.Name;this.SelectedPane=$(this.elemVisual).find("#lstSeqSub")[0];this.SelectionPane=$(this.elemVisual).find("#lstSelection")[0];
var selectedSubstance=this.Substances;if(!this.SelectedPane.childElementCount&&selectedSubstance)while(selectedSubstance){selectedSubstance.declareSubstance(this.SelectedPane,Sequence.MetaHandler);var visualSel=selectedSubstance.Visual.cloneNode(true);this.SelectedPane.appendChild(visualSel);visualSel.parentSubstance=selectedSubstance;visualSel.sequenceOwner=this;visualSel.addEventListener("click",this.unselectSubstance);selectedSubstance=this.Substances}if(!this.SelectionPane.childElementCount)for(var j=
0;j<this.listeSubstances.length;j++){var subDisp=this.listeSubstances[j];if(subDisp.elemVisual.onclick)subDisp.elemVisual.removeEventListener("click",subDisp.elemVisual.onclick);subDisp.foldSubstance();var visuelEl=subDisp.Visual.cloneNode(true);visuelEl.parentSubstance=subDisp;visuelEl.sequenceOwner=this;visuelEl.addEventListener("click",this.selectSubstance);this.SelectionPane.appendChild(visuelEl)}}if(!this.Meta);return this.elemVisual};
Sequence.prototype.updateVisual=function(){if(!this.elemVisual){var link=document.querySelector('link[rel="import"]');var article=link.import.querySelector("#seqTab");this.elemVisual=article.cloneNode(true)}var vid=$(this.elemVisual).find("#vidSeq")[0];vid.src=this.Url;vid.ownerSeq=this;vid.onclick=function(eve){var dispPane=ApplicationRepertoire.Pane;$(dispPane).empty();seqActive=eve.currentTarget.ownerSeq;seqActive.elemVisual=null;dispPane.appendChild(seqActive.Visual)}};
Sequence.prototype.foldSequence=function(){this.SelectedPane.style.display="none";this.SelectionPane.style.display="none"};Sequence.prototype.openSequence=function(){this.SelectedPane.style.display="";this.SelectionPane.style.display=""};
function ApplicationRepertoire(fileName,metaName,dispPane){RepertoireSubstance.call(this,fileName);var sMeta=metaName;var iter=0;var seqPane=dispPane;function fleshSeq(node){var subLiees=node.getElementsByTagName("SubstancesLiees");var seqSubstances=[];for(var i=0;i<subLiees.length;i++){var sub=this.retrieveSeqChild(subLiees[i].getAttribute("IdSubstance"));seqSubstances.push(sub)}var newSequence=new Sequence(node,seqSubstances);return newSequence}this.updatePane=function(dispPane,newSeq){if(newSeq)this.Sequences=
newSeq;if(ApplicationRepertoire.ListeSequences.length!=dispPane.childElementCount){$(dispPane).empty();var seqElem=this.Sequences;while(seqElem){dispPane.appendChild(seqElem.SeqVideo);seqElem=this.Sequences}}ApplicationRepertoire.Pane=dispPane};Object.defineProperty(this,"Sequences",{get:function(){if(iter>=ApplicationRepertoire.ListeSequences.length){iter=0;return null}return ApplicationRepertoire.ListeSequences[iter++]},set:function(newVal){ApplicationRepertoire.ListeSequences.push(newVal)}});this.researchSubstance=
function(){this.parent.xEx=this.xDoc.cloneNode(true);var listSub=this.parent.xDoc.evaluate("//DictionnaireSubstance/*",this.xDoc,null,XPathResult.ANY_TYPE,null);var node;while(node=listSub.iterateNext()){var substanceRes=this.fleshNode.call(this,node);this.parent.listeSubstances.push(substanceRes)}var listSub2=this.parent.xEx.evaluate("//DictionnaireSubstance/*",this.parent.xEx,null,XPathResult.ANY_TYPE,null);var node2;while(node2=listSub2.iterateNext()){var substanceRes2=this.parent.fleshNode(node2);
ApplicationRepertoire.metaSubstances.push(substanceRes2)}var listSeq=this.parent.xEx.evaluate("//Sequence",this.parent.xEx,null,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);var seqNode=null;while(seqNode=listSeq.iterateNext()){var sequence=fleshSeq.call(this,seqNode);this.Sequences=sequence}listSeq=this.parent.xEx.evaluate("//Imaginaire",this.parent.xEx,null,XPathResult.ORDERED_NODE_ITERATOR_TYPE,null);seqNode=null;while(seqNode=listSeq.iterateNext()){var sequence=fleshSeq.call(this,seqNode);this.Sequences=
sequence}}}ApplicationRepertoire.inheritsFrom(RepertoireSubstance);ApplicationRepertoire.ListeSequences=[];ApplicationRepertoire.ActiveSubstances=[];ApplicationRepertoire.metaSubstances=[];ApplicationRepertoire.NbURL=0;ApplicationRepertoire.Pane;ApplicationRepertoire.NouSub=function(sub){if(ApplicationRepertoire.metaSubstances.indexOf(sub)<0&&ApplicationRepertoire.ActiveSubstances.indexOf(sub)<0)ApplicationRepertoire.ActiveSubstances.push(sub)};
ApplicationRepertoire.prototype.retrieveSeqChild=function(subId){for(var i=0;i<ApplicationRepertoire.metaSubstances.length;i++){var sub=ApplicationRepertoire.metaSubstances[i];if(sub.Id==subId)return sub}return null};
ApplicationRepertoire.prototype.recordAppData=function(){var dicoSub=this.xEx.firstChild.getElementsByTagName("DictionnaireSubstance")[0];for(var i=0;ApplicationRepertoire.ActiveSubstances&&i<ApplicationRepertoire.ActiveSubstances.length;i++){var sub=ApplicationRepertoire.ActiveSubstances[i];dicoSub.appendChild(sub.SubX.cloneNode(true))}this.parent.xDoc=this.parent.xEx;this.writeDico();var liElems=this.parent.xEx.evaluate("//*[@Url]",this.parent.xEx,null,XPathResult.ANY_TYPE,null);var elems;while(elems=
liElems.iterateNext()){ApplicationRepertoire.NbURL++;this.decodeUrl(elems)}};ApplicationRepertoire.prototype.decodeUrl=function(uEl){if(!uEl)return;var bucket=this.bucket;var that=this;var params={Key:uEl.getAttribute("Url")};bucket.getObject(params,function(err,meta){if(err)console.log="Couldn't find Url"+err.message;else{var sPath=bucket.getSignedUrl("getObject",params);uEl.textContent=encodeURI(sPath);if(--ApplicationRepertoire.NbURL<=0)window.alert("Enregistrement complete")}})};
ApplicationRepertoire.prototype.uploadApplication=function(sAppPath){var that=this;if(this.xEx){xKey="User:"+this.fbUserId+"/"+Substance.MetaDataName+".xml";var sDoc=(new XMLSerializer).serializeToString(this.xEx);var params={Key:xKey,ContentType:"text/xml",Body:sDoc,ACL:"public-read"};this.bucket.putObject(params,function(err,data){if(err)console.log="ERROR: "+err;else{that.launchApp(sAppPath);console.log="Upload completed."}})}};
ApplicationRepertoire.prototype.launchApp=function(sAppPath){xKey="User:"+this.fbUserId+"/"+Substance.MetaDataName+".xml";var xmlUrl=OBJECT_LINK+"User:"+this.fbUserId+"/"+Substance.MetaDataName+".xml";localStorage.setItem("applicationSub",xmlUrl);sAppPath=sAppPath+"?"+this.fbUserId+"/"+Substance.MetaDataName;var appWin=window.open(sAppPath)};
